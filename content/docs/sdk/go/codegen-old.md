---
title: "Go SDK的proto代码生成(旧版)"
linkTitle: "proto代码生成(旧版)"
weight: 3103
date: 2021-01-31
description: >
  Dapr的Go SDK中更新protos生成源文件
---

{{% pageinfo %}}
旧版的proto代码生成，非常麻烦，新版改进之后就不要这么折腾了。

本文归档备用。
{{% /pageinfo %}}

## 准备工作

安装特定版本的相关文件

如果直接用brew命令安装，默认是安装当前最新版本：

```bash
brew install protobuf  						//protobuf-3.14.0
brew install grpc 								// grpc-1.33.2_1
brew install protoc-gen-go-grpc 	// protoc-gen-go-grpc-1.0.1_1
```

但是生成的go文件会和目前go-sdk上已有的文件有非常大的差异，原因应该是上面几个工具的版本造成的。

在go-sdk中未能找到具体的版本要求，但是在`darp/dapr`项目下的 `dapr/proto/READEME.md` 文件中有如下说明：

> Prerequsites
>
> Because of [etcd dependency issue](https://github.com/etcd-io/etcd/issues/11563), contributor needs to use the below verisons of tools to generate gRPC protobuf clients.
>
> * protoc version: [v3.11.0](https://github.com/protocolbuffers/protobuf/releases/tag/v3.11.0)
> * protobuf protoc-gen-go: [v1.3.2](https://github.com/golang/protobuf/releases/tag/v1.3.2)
> * gRPC version: [v1.26.0](https://github.com/grpc/grpc-go/releases/tag/v1.26.0)

这个README文件中有如何安装上述特定版本的方式，参考原文操作如下：

1. 清理上面已安装的版本

    ```bash
    brew remove grpc protoc-gen-go-grpc protobuf
    ```

2. 手工安装 protoc v3.11.0

    - 下载对应版本： [mac](https://github.com/protocolbuffers/protobuf/releases/download/v3.11.0/protoc-3.11.0-osx-x86_64.zip) 
    - 解压缩之后复制二进制文件到Path路径下，一般习惯放到 `/usr/local/bin` 下
    - 将include目录的内容复制到 `/usr/local/include`
        - cp -r protoc-3.11.0-osx-x86_64/include/ /usr/local/include
        - 如果这一步没有执行，则后面会报错： `Import "google/protobuf/empty.proto" was not found or had errors`
    - 执行`protoc --version` 验证一下版本

3. 手工构建 protoc-gen-go ： 参考README中的详细步骤

## 将proto生成源码

执行命令：

```bash
protoc -I . ./dapr/proto/runtime/v1/dapr.proto --go_out=plugins=grpc:.
```

生成的代码存放在当前目录下的 `github.com/dapr/dapr/pkg/proto/runtime/v1/dapr.pb.go`

将其复制到现有dapr项目存放生成文件的目录 `pkg/proto/runtime/v1/`

这个方式生成的go源码可以做到和dapr/dapr项目下提交的go源码完全一致。

但和 go-sdk项目中的源码差异非常大，再次猜测是版本问题，

```
// Code generated by protoc-gen-go. DO NOT EDIT.
// versions:
// 	protoc-gen-go v1.25.0
// 	protoc        v3.13.0
// source: dapr/proto/runtime/v1/dapr.proto
```

 将protoc换成对应的版本之后，代码生成基本一致了。

> 备注：给dapr提了建议，希望后续能把dapr/dapr和dapr/go-sdk中的版本升级并保持一致，已经被接受，后续应该不用这么麻烦了。

## 其他

### 期间的特殊错误处理

运行`make protos`时，遇到过一个莫名其妙的报错:

```bash
 % make protos
go install github.com/gogo/protobuf/gogoreplace
cannot find package "." in:
        /Users/sky/work/code/skyao/go-sdk/vendor/github.com/gogo/protobuf/gogoreplace
make: *** [protos] Error 1
```

没找到合理的解决方案，只好用了一个很土的办法：

1. 修改 go.mod 文件，加入依赖 

    `require github.com/gogo/protobuf v1.3.1`

2. 为了拉取文件，加入一个go文件，内容只有一行: 

    `import _ "github.com/gogo/protobuf/gogoreplace"`

    不要管ide的报错，这两个事情的目的只是为了能拉取gogo/protobuf/gogoreplace的文件到本地，避免上面的报错而已。

    完成之后，回滚上面的改动。

